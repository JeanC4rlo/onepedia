name: Gerar PÃ¡ginas da Wiki

on:
  push:
    branches: [ main, master ]
  schedule:
    - cron: '0 0 * * *'  # Diariamente Ã s 00:00 UTC
  workflow_dispatch:

jobs:
  generate:
    runs-on: ubuntu-latest
    
    steps:
    # 1. PREPARAÃ‡ÃƒO
    - name: Preparar ambiente
      run: |
        echo "ğŸ“¦ Preparando ambiente..."
        
    - name: Baixar cÃ³digo
      uses: actions/checkout@v4
      
    - name: Instalar Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    # 2. EXECUÃ‡ÃƒO
    - name: Rodar script
      run: |
        echo "ğŸš€ Executando script de geraÃ§Ã£o..."
        node generate.js
        
    # 3. VERIFICAÃ‡ÃƒO CORRIGIDA
    - name: Verificar mudanÃ§as
      id: check
      run: |
        echo "ğŸ” Verificando se hÃ¡ mudanÃ§as..."
        
        # Verifica se hÃ¡ ALGUMA mudanÃ§a na pasta wiki
        # Usa --porcelain que retorna vazio se nÃ£o houver mudanÃ§as
        if [ -z "$(git status --porcelain wiki/)" ]; then
          echo "âŒ NÃ£o hÃ¡ mudanÃ§as na pasta wiki"
          echo "CHANGES=no" >> $GITHUB_ENV
        else
          echo "âœ… HÃ¡ mudanÃ§as na pasta wiki"
          echo "CHANGES=yes" >> $GITHUB_ENV
          
          # Mostra o que mudou
          echo "Arquivos modificados:"
          git status --porcelain wiki/
        fi
        
    # 4. COMMIT (se tiver mudanÃ§as) - CORRIGIDO
    - name: Fazer commit
      if: env.CHANGES == 'yes'
      run: |
        echo "ğŸ’¾ Configurando Git..."
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git config user.name "github-actions[bot]"
        
        echo "ğŸ“ Coletando slugs modificados e adicionados..."
        
        # Data formatada
        DATA=$(date '+%d/%m/%Y %H:%M')
        
        # IMPORTANTE: Primeiro adiciona os arquivos ao staging
        git add wiki/
        
        # Pega slugs ADICIONADOS (novos) - status "A" no staging
        SLUGS_ADD=$(git diff --cached --name-status wiki/ | grep "^A" | cut -f2 | sed 's|wiki/||' | cut -d'/' -f1 | sort -u)
        
        # Pega slugs MODIFICADOS (jÃ¡ existentes) - status "M" no staging
        SLUGS_MOD=$(git diff --cached --name-status wiki/ | grep "^M" | cut -f2 | sed 's|wiki/||' | cut -d'/' -f1 | sort -u)
        
        # Conta
        QTD_ADD=$(echo "$SLUGS_ADD" | wc -w)
        QTD_MOD=$(echo "$SLUGS_MOD" | wc -w)
        QTD_TOTAL=$((QTD_ADD + QTD_MOD))
        
        echo "ğŸ“ Criando mensagem de commit..."
        
        # ComeÃ§a mensagem com data
        MSG="ğŸ“š AtualizaÃ§Ã£o Wiki - $DATA"
        
        # Adiciona slugs se houver
        if [ "$QTD_TOTAL" -gt 0 ]; then
          MSG="$MSG
          
        ğŸ“‹ SLUGS ATUALIZADOS:"
                  
                  # Adiciona slugs novos [Add]
                  for SLUG in $SLUGS_ADD; do
                    MSG="$MSG
        [Add] $SLUG"
                  done
                  
                  # Adiciona slugs modificados [Mod]
                  for SLUG in $SLUGS_MOD; do
                    MSG="$MSG
        [Mod] $SLUG"
                  done
                  
                  # Resumo
                  MSG="$MSG

        ğŸ“Š RESUMO:
        â€¢ Data: $DATA
        â€¢ Adicionados: $QTD_ADD
        â€¢ Modificados: $QTD_MOD
        â€¢ Total: $QTD_TOTAL slug(s)"
                else
                  MSG="$MSG

        â„¹ï¸ Nenhum slug modificado"
                fi
                
                echo "ğŸ“ Commitando..."
                echo "$MSG" | git commit -F -
                
    # 5. PUSH (se tiver mudanÃ§as)
    - name: Fazer push
      if: env.CHANGES == 'yes'
      run: |
        echo "ğŸ“¤ Enviando para GitHub..."
        git push
        
    # 6. FINALIZAÃ‡ÃƒO
    - name: Mostrar resultado
      run: |
        echo " "
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "âœ… PROCESSO FINALIZADO"
        
        if [ "$CHANGES" = "yes" ]; then
          echo "ğŸ“ AlteraÃ§Ãµes salvas no GitHub"
        else
          echo "ğŸ“­ Nenhuma alteraÃ§Ã£o necessÃ¡ria"
        fi
        
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"