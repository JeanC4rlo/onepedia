name: Gerar PÃ¡ginas da Wiki

on:
  push:
    branches: [ main, master ]
    paths:
      - "generate.js"
      - "*.js"
      - "**/*.js"
      - "templates/**"
  schedule:
    - cron: "*/20 * * * *"   # a cada 20 minutos
  workflow_dispatch:

jobs:
  generate:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      # 1. PREPARAÃ‡ÃƒO
      - name: Preparar ambiente
        run: |
          echo "ğŸ“¦ Preparando ambiente..."

      - name: Baixar cÃ³digo
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Instalar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      # 2. EXECUÃ‡ÃƒO
      - name: Rodar script
        run: |
          echo "ğŸš€ Executando script de geraÃ§Ã£o..."
          node generate.js

      # 3. VERIFICAÃ‡ÃƒO
      - name: Verificar mudanÃ§as
        id: check
        run: |
          echo "ğŸ” Verificando se hÃ¡ mudanÃ§as..."

          # Verifica se hÃ¡ mudanÃ§as na pasta wiki
          if [ -z "$(git status --porcelain wiki/)" ]; then
            echo "âŒ NÃ£o hÃ¡ mudanÃ§as na pasta wiki"
            echo "CHANGES=no" >> $GITHUB_ENV
          else
            echo "âœ… HÃ¡ mudanÃ§as na pasta wiki"
            echo "CHANGES=yes" >> $GITHUB_ENV

            echo "Arquivos modificados:"
            git status --porcelain wiki/
          fi

      # 4. COMMIT (somente se houver mudanÃ§as)
      - name: Fazer commit
        if: env.CHANGES == 'yes'
        run: |
          echo "ğŸ’¾ Configurando Git..."
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git config user.name "github-actions[bot]"

          echo "ğŸ“ Coletando slugs modificados e adicionados..."

          DATA=$(date '+%d/%m/%Y %H:%M')

          git add wiki/

          SLUGS_ADD=$(git diff --cached --name-status wiki/ | grep "^A" | cut -f2 | sed 's|wiki/||' | cut -d'/' -f1 | sort -u)
          SLUGS_MOD=$(git diff --cached --name-status wiki/ | grep "^M" | cut -f2 | sed 's|wiki/||' | cut -d'/' -f1 | sort -u)

          QTD_ADD=$(echo "$SLUGS_ADD" | wc -w)
          QTD_MOD=$(echo "$SLUGS_MOD" | wc -w)
          QTD_TOTAL=$((QTD_ADD + QTD_MOD))

          echo "ğŸ“ Criando mensagem de commit..."

          MSG="ğŸ“š AtualizaÃ§Ã£o Wiki - $DATA"

          if [ "$QTD_TOTAL" -gt 0 ]; then
            MSG="$MSG

          ğŸ“‹ SLUGS ATUALIZADOS:"
            
            for SLUG in $SLUGS_ADD; do
              MSG="$MSG
            [Add] $SLUG"
            done

            for SLUG in $SLUGS_MOD; do
              MSG="$MSG
            [Mod] $SLUG"
            done

            MSG="$MSG

          ğŸ“Š RESUMO:
          â€¢ Data: $DATA
          â€¢ Adicionados: $QTD_ADD
          â€¢ Modificados: $QTD_MOD
          â€¢ Total: $QTD_TOTAL slug(s)"
          else
            MSG="$MSG

          â„¹ï¸ Nenhum slug modificado"
          fi

          echo "ğŸ“ Commitando..."
          echo "$MSG" | git commit -F -

      # 5. PUSH
      - name: Fazer push
        if: env.CHANGES == 'yes'
        run: |
          echo "ğŸ“¤ Enviando para GitHub..."
          git push

      # 6. FINALIZAÃ‡ÃƒO
      - name: Mostrar resultado
        run: |
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "âœ… PROCESSO FINALIZADO"

          if [ "$CHANGES" = "yes" ]; then
            echo "ğŸ“ AlteraÃ§Ãµes salvas no GitHub"
          else
            echo "ğŸ“­ Nenhuma alteraÃ§Ã£o necessÃ¡ria"
          fi

          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
